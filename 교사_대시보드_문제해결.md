# 🔧 교사 대시보드 문제 해결 가이드

## ❓ 문제: 학생 이름 클릭 시 로그인 화면으로 이동

### 원인

교사 대시보드에서 학생 이름을 클릭했을 때 로그인 화면으로 이동하는 문제는 다음과 같은 원인이 있을 수 있습니다:

1. **Middleware 설정 문제** ✅ 해결됨
   - `/teacher` 경로가 middleware에서 제외되지 않아 세션 문제 발생
   - 수정: `src/middleware.ts`에 `/teacher` 경로 제외 추가

2. **Admin API 권한 문제** ✅ 해결됨
   - `supabase.auth.admin.getUserById()` 호출 시 권한 부족
   - 수정: 에러 처리 추가, 이메일 없이도 진행 가능하도록 변경

3. **평가 결과가 없는 경우** ⚠️ 정상 동작
   - 학생이 아직 평가를 보지 않았어도 페이지는 정상 표시됨
   - 통계가 0으로 표시됨

---

## ✅ 적용된 수정 사항

### 1. Middleware 수정 (`src/middleware.ts`)

**변경 전:**
```typescript
'/((?!_next/static|_next/image|favicon.ico|results).*)',
```

**변경 후:**
```typescript
'/((?!_next/static|_next/image|favicon.ico|results|teacher).*)',
```

**효과:**
- `/teacher` 경로에서 middleware 인증 체크를 건너뜀
- 교사 페이지에서 세션 문제 해결

---

### 2. 학생 상세 페이지 수정 (`src/app/teacher/student/[studentId]/page.tsx`)

**변경 전:**
```typescript
const { data: { user: studentUser } } = await supabase.auth.admin.getUserById(studentId);
```

**변경 후:**
```typescript
let studentUser = null;
try {
  const { data } = await supabase.auth.admin.getUserById(studentId);
  studentUser = data.user;
} catch (error) {
  console.error('학생 이메일 조회 에러:', error);
  // 이메일을 가져오지 못해도 계속 진행
}
```

**효과:**
- Admin API 에러가 발생해도 페이지가 정상 작동
- 이메일 정보 없이도 학생 정보 표시 가능

---

### 3. 교사 대시보드 수정 (`src/app/teacher/dashboard/page.tsx`)

**변경 전:**
```typescript
const { data: { users } } = await supabase.auth.admin.listUsers();
```

**변경 후:**
```typescript
let users = [];
try {
  const { data } = await supabase.auth.admin.listUsers();
  users = data.users || [];
} catch (error) {
  console.error('사용자 목록 조회 에러:', error);
  // 이메일을 가져오지 못해도 계속 진행
}
```

**효과:**
- 사용자 목록 조회 실패 시에도 대시보드 정상 작동
- 학생 이름으로 표시 (이메일 없이도 가능)

---

## 🧪 테스트 방법

### 1. 교사 계정으로 로그인
```
이메일: [교사 이메일]
비밀번호: [교사 비밀번호]
```

### 2. 교사 대시보드 접근
- 로비에서 "🎓 교사 관리 대시보드" 클릭
- 학생 목록이 정상적으로 표시되는지 확인

### 3. 학생 상세 페이지 접근
- 학생 이름 클릭
- **로그인 화면으로 이동하지 않고** 학생 상세 페이지가 표시되어야 함

### 4. 평가 결과가 없는 학생
- 아직 평가를 보지 않은 학생 클릭
- 페이지는 정상 표시되고, 모든 통계가 0으로 표시됨
- "아직 평가 기록이 없습니다" 메시지 표시

---

## 🔍 추가 확인 사항

### Service Role Key 확인

`.env.local` 파일에 Service Role Key가 올바르게 설정되어 있는지 확인:

```bash
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**확인 방법:**
1. Supabase Dashboard → Settings → API
2. **Service Role Key** 복사 (secret key)
3. `.env.local`에 붙여넣기

⚠️ **주의:** Service Role Key는 절대 클라이언트 코드나 Git에 노출하면 안 됩니다!

---

### RLS 정책 확인

교사가 학생 정보를 조회할 수 있도록 RLS 정책이 설정되어 있는지 확인:

```sql
-- user_profiles 테이블
SELECT * FROM pg_policies 
WHERE tablename = 'user_profiles';

-- teacher_student_assignments 테이블
SELECT * FROM pg_policies 
WHERE tablename = 'teacher_student_assignments';

-- test_results 테이블
SELECT * FROM pg_policies 
WHERE tablename = 'test_results';
```

**필요한 정책:**
- ✅ Teachers can view their students' profiles
- ✅ Teachers can view their assignments
- ✅ Teachers can view their students' results

---

## 🐛 여전히 문제가 발생하는 경우

### 1. 브라우저 캐시 삭제
```
Ctrl + Shift + Delete
→ 쿠키 및 사이트 데이터 삭제
→ 다시 로그인
```

### 2. 개발 서버 재시작
```bash
# 터미널에서 Ctrl+C로 중지 후
npm run dev
```

### 3. 브라우저 콘솔 확인
```
F12 → Console 탭
→ 에러 메시지 확인
```

### 4. 서버 로그 확인
```
터미널에서 npm run dev 실행 중인 창
→ 에러 메시지 확인
```

---

## 📊 정상 동작 확인

### ✅ 교사 대시보드
- [ ] 담당 학생 목록이 표시됨
- [ ] 반별로 그룹화되어 표시됨
- [ ] 각 학생의 통계 (테스트 수, 완료율, 정확도) 표시
- [ ] 학생 카드에 마우스 오버 시 하이라이트

### ✅ 학생 상세 페이지
- [ ] 학생 기본 정보 (이름, 반, 번호, 학년) 표시
- [ ] 6가지 테스트별 통계 표시
- [ ] 막대 차트 정상 표시
- [ ] 레이더 차트 정상 표시
- [ ] 종합 평가 코멘트 표시
- [ ] 평가 세션 기록 표시 (있는 경우)

### ✅ 평가 결과가 없는 학생
- [ ] 페이지가 정상 표시됨 (로그인 화면으로 이동하지 않음)
- [ ] 모든 통계가 0으로 표시됨
- [ ] "아직 평가 기록이 없습니다" 메시지 표시

---

## 💡 추가 개선 사항 (향후)

1. **로딩 상태 표시**
   - 페이지 로딩 중 스피너 표시
   - 데이터 로딩 실패 시 친절한 에러 메시지

2. **에러 페이지 개선**
   - 404 페이지 커스터마이징
   - 권한 없음 페이지 개선

3. **성능 최적화**
   - 학생 목록 페이지네이션
   - 이미지 lazy loading

4. **사용자 경험 개선**
   - 학생 검색 기능
   - 반별 필터링
   - 정렬 옵션 (이름, 성적 등)

---

**문제가 해결되었나요? 🎉**

추가 질문이 있으시면 개발팀에 문의해주세요!


# 🔧 교사 대시보드 → 학생 상세 페이지 문제 해결 가이드

## 📋 증상
교사 대시보드에서 학생 이름을 클릭하면 로그인 페이지로 리다이렉트됨

---

## 🔍 문제 진단 방법

### 1. 브라우저 개발자 도구 열기
- **Windows**: `F12` 또는 `Ctrl + Shift + I`
- **Mac**: `Cmd + Option + I`

### 2. Console 탭 확인
학생 이름을 클릭했을 때 다음 로그를 확인하세요:

```
[StudentDetail] Auth check: { hasUser: ..., userId: ..., error: ..., studentId: ..., timestamp: ... }
```

#### 경우 1: 로그가 전혀 보이지 않음
→ **원인**: 페이지가 로드되기 전에 리다이렉트됨
→ **해결**: middleware 또는 세션 쿠키 문제

#### 경우 2: `hasUser: false` 또는 `error: "..."`
→ **원인**: 세션이 만료되었거나 쿠키가 전달되지 않음
→ **해결**: 아래 해결 방법 참조

#### 경우 3: `hasUser: true`이지만 여전히 리다이렉트
→ **원인**: 교사 프로필 또는 권한 문제
→ **해결**: Supabase 데이터베이스 확인

---

## ✅ 적용된 수정 사항

### 1. **Link → `<a>` 태그로 변경**
```typescript
// 이전 (클라이언트 사이드 라우팅)
<Link href={`/teacher/student/${student.id}`}>

// 현재 (전체 페이지 리로드)
<a href={`/teacher/student/${student.id}`}>
```
→ 전체 페이지 리로드로 쿠키가 확실히 전달됨

### 2. **Supabase 쿠키 처리 개선**
```typescript
// getAll/setAll 패턴 사용 (Supabase SSR 권장)
cookies: {
  getAll() {
    return cookieStore.getAll();
  },
  setAll(cookiesToSet) {
    // ...
  },
}
```

### 3. **상세한 디버깅 로그 추가**
```typescript
console.log('[StudentDetail] Auth check:', { 
  hasUser: !!user, 
  userId: user?.id,
  error: userError?.message,
  studentId,
  timestamp: new Date().toISOString()
});
```

---

## 🛠️ 해결 방법

### 방법 1: 브라우저 캐시 및 쿠키 삭제

1. Chrome/Edge:
   - `F12` → Application 탭
   - 왼쪽 메뉴에서 "Cookies" 선택
   - 사이트 도메인 선택
   - 모든 쿠키 삭제
   - 페이지 새로고침

2. 시크릿/incognito 모드로 테스트
   - 새 시크릿 창 열기
   - 로그인 후 다시 시도

### 방법 2: 세션 만료 확인

**Supabase Dashboard에서 확인:**
1. Supabase Dashboard → Authentication → Users
2. 해당 교사 계정의 "Last Sign In" 시간 확인
3. 너무 오래되었다면 다시 로그인

**로컬에서 확인:**
```sql
-- Supabase SQL Editor에서 실행
SELECT 
  id, 
  email, 
  last_sign_in_at,
  NOW() - last_sign_in_at AS time_since_login
FROM auth.users
WHERE email = 'teacher@example.com';
```

### 방법 3: 교사 프로필 확인

**Supabase SQL Editor에서 실행:**
```sql
-- 교사 프로필 확인
SELECT 
  up.id,
  au.email,
  up.full_name,
  up.role
FROM user_profiles up
JOIN auth.users au ON up.id = au.id
WHERE au.email = 'teacher@example.com';
```

**결과가 없거나 role이 'teacher'가 아니면:**
```sql
-- 교사 역할 설정
UPDATE user_profiles
SET role = 'teacher'
WHERE id = 'YOUR-USER-ID';
```

### 방법 4: 학생 배정 확인

```sql
-- 교사-학생 배정 확인
SELECT 
  tsa.teacher_id,
  tsa.student_id,
  t.full_name AS teacher_name,
  s.full_name AS student_name
FROM teacher_student_assignments tsa
JOIN user_profiles t ON tsa.teacher_id = t.id
JOIN user_profiles s ON tsa.student_id = s.id
WHERE tsa.teacher_id = 'YOUR-TEACHER-ID';
```

**배정이 없다면:**
```sql
-- 학생 배정 (TEACHER_SETUP_GUIDE.md 참조)
INSERT INTO teacher_student_assignments (teacher_id, student_id, class_name)
VALUES ('teacher-uuid', 'student-uuid', '나루초 3학년 다솜반');
```

### 방법 5: Middleware 로그 확인

**Vercel Dashboard에서:**
1. Vercel Dashboard → 프로젝트 선택
2. **Deployments** → 최신 배포 선택
3. **Functions** → 로그 확인
4. "Auth error in middleware" 메시지 확인

---

## 🔬 고급 디버깅

### Network 탭에서 쿠키 확인

1. 개발자 도구 → Network 탭
2. 학생 이름 클릭
3. `/teacher/student/[id]` 요청 찾기
4. Headers 탭 → Request Headers
5. `Cookie` 헤더 확인:
   ```
   Cookie: sb-xxxx-auth-token=...; sb-xxxx-auth-token-code-verifier=...
   ```

**쿠키가 없다면:**
- 교사 대시보드에서 쿠키가 설정되지 않음
- 로그아웃 후 다시 로그인

### Console에서 수동 세션 확인

```javascript
// 브라우저 Console에서 실행
fetch('/api/auth/session', {
  credentials: 'include'
}).then(r => r.json()).then(console.log);
```

---

## 📌 예방 조치

### 1. 세션 자동 갱신
- Supabase는 기본적으로 1시간마다 세션 갱신
- middleware가 제대로 작동하면 자동 갱신됨

### 2. 긴 세션 유지
Supabase Dashboard에서 세션 만료 시간 연장:
1. Authentication → Settings
2. **Auth Session** 섹션
3. "JWT Expiry" 조정 (기본: 3600초 = 1시간)

### 3. 정기적인 로그인
- 교사는 매일 새로 로그인하는 것을 권장
- 세션 만료 전에 자동 로그인 구현 고려

---

## 🚨 긴급 임시 해결책

교사가 급하게 학생 정보를 확인해야 한다면:

### 옵션 1: 직접 URL 입력
```
https://your-site.vercel.app/teacher/student/STUDENT-UUID
```
- 학생 UUID는 Supabase에서 확인
- 브라우저 주소창에 직접 입력

### 옵션 2: 새 탭에서 열기
- 학생 이름에 마우스 오른쪽 클릭
- "새 탭에서 열기" 선택
- 전체 페이지 리로드로 세션 전달

---

## 📞 추가 지원

위 방법으로도 해결되지 않으면 다음 정보를 수집하세요:

1. **브라우저 Console 로그**
   - `[StudentDetail] Auth check` 메시지
   - 다른 에러 메시지

2. **Network 탭 정보**
   - 요청 URL
   - 응답 상태 코드
   - Cookie 헤더 유무

3. **환경 정보**
   - 브라우저 종류 및 버전
   - 로그인한 교사 이메일
   - 클릭한 학생 이름

4. **Supabase 확인**
   - 교사 role이 'teacher'인지
   - teacher_student_assignments 존재 여부

---

## ✅ 체크리스트

배포 후 확인할 사항:

- [ ] 브라우저 캐시 삭제
- [ ] 시크릿 모드에서 테스트
- [ ] Console에서 `[StudentDetail] Auth check` 로그 확인
- [ ] Network 탭에서 Cookie 헤더 확인
- [ ] Supabase에서 교사 role 확인
- [ ] teacher_student_assignments 테이블 확인
- [ ] 다시 로그인 후 재시도

---

**대부분의 경우 브라우저 캐시 삭제 + 다시 로그인으로 해결됩니다!** 🎉


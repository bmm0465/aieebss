# 🚀 학생 계정 일괄 생성 가이드

이 가이드는 이메일과 비밀번호를 포함한 112명의 학생 계정을 자동으로 생성하는 방법을 안내합니다.

## 📋 생성될 계정 형식

### 이메일 및 비밀번호 규칙

| 학교 | 형식 | 예시 |
|------|------|------|
| 나루초 | `naru{번호}@abs.com` / `naru{번호}` | naru1@abs.com / naru1 |
| 우암초 | `uam{번호}@abs.com` / `uam{번호}` | uam1@abs.com / uam1 |
| 단재초 1반 | `1danjae{번호}@abs.com` / `1danjae{번호}` | 1danjae1@abs.com / 1danjae1 |
| 단재초 2반 | `2danjae{번호}@abs.com` / `2danjae{번호}` | 2danjae1@abs.com / 2danjae1 |
| 단재초 3반 | `3danjae{번호}@abs.com` / `3danjae{번호}` | 3danjae1@abs.com / 3danjae1 |

---

## 🎯 방법 1: Supabase Dashboard 수동 등록 (추천)

### 1단계: CSV 파일 준비
`학생_이메일_비밀번호_목록.csv` 파일을 사용합니다.

### 2단계: Supabase에서 계정 생성

**각 학생마다 반복:**
1. Supabase Dashboard → Authentication → Users
2. **Add user** 클릭
3. 정보 입력:
   - Email: `naru1@abs.com`
   - Password: `naru1`
   - Auto Confirm User: ✅ 체크
4. **Create user** 클릭
5. 생성된 User UID 복사

### 3단계: 프로필과 연결

생성된 UUID를 사용하여 SQL 실행:

```sql
-- 1. user_profiles 업데이트
UPDATE user_profiles
SET id = '생성된-UUID'
WHERE full_name = '고도윤' AND class_name = '나루초 3학년 다솜반';

-- 2. 교사에게 배정
INSERT INTO teacher_student_assignments (teacher_id, student_id, class_name)
VALUES ('14ea1f09-1c7f-43eb-95cf-1b491dd876a4', '생성된-UUID', '나루초 3학년 다솜반')
ON CONFLICT (teacher_id, student_id) DO NOTHING;
```

---

## 🤖 방법 2: Node.js 스크립트 자동화 (빠름)

### 전제 조건
- Node.js 설치 필요
- Supabase Service Role Key 필요

### 1단계: 환경 설정

```bash
# 의존성 설치
npm install @supabase/supabase-js csv-parser dotenv
```

### 2단계: .env 파일 생성

프로젝트 루트에 `.env` 파일 생성:

```env
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
```

### 3단계: 스크립트 실행

```bash
node create_student_accounts.js
```

**실행 과정:**
1. CSV 파일 읽기
2. 각 학생마다:
   - Auth 계정 생성
   - user_profiles에 프로필 생성
   - 교사에게 자동 배정
3. 결과 출력

**예상 출력:**
```
📚 총 112명의 학생 계정 생성 시작...

✅ 고도윤 (naru1@abs.com) - 성공
✅ 권아정 (naru2@abs.com) - 성공
✅ 김도현 (naru3@abs.com) - 성공
...

📊 완료! 성공: 112명, 실패: 0명
```

---

## 🔧 방법 3: Supabase Admin API (Python)

Python을 선호하는 경우:

```python
import os
import csv
import requests
from supabase import create_client, Client

SUPABASE_URL = os.environ.get("SUPABASE_URL")
SUPABASE_KEY = os.environ.get("SUPABASE_SERVICE_ROLE_KEY")

supabase: Client = create_client(SUPABASE_URL, SUPABASE_KEY)

# 교사 매핑
teacher_mapping = {
    '나루초 3학년 다솜반': '14ea1f09-1c7f-43eb-95cf-1b491dd876a4',
    '우암초 3학년 1반': 'fe2e88ce-bc53-4c37-825b-4bff261ef1a9',
    '단재초 4학년 1반': '3c9db811-8b08-48bc-8f0e-d515fa045d51',
    '단재초 4학년 2반': '3c9db811-8b08-48bc-8f0e-d515fa045d51',
    '단재초 4학년 3반': '3c9db811-8b08-48bc-8f0e-d515fa045d51',
}

with open('학생_이메일_비밀번호_목록.csv', 'r', encoding='utf-8') as f:
    reader = csv.DictReader(f)
    for row in reader:
        try:
            # Auth 계정 생성
            auth_response = supabase.auth.admin.create_user({
                "email": row['email'],
                "password": row['password'],
                "email_confirm": True,
                "user_metadata": {
                    "full_name": row['full_name'],
                    "class_name": row['class_name']
                }
            })
            
            user_id = auth_response.user.id
            
            # 프로필 생성
            supabase.table('user_profiles').insert({
                "id": user_id,
                "full_name": row['full_name'],
                "role": "student",
                "class_name": row['class_name'],
                "student_number": row['student_number'],
                "grade_level": row['grade_level']
            }).execute()
            
            # 교사 배정
            teacher_id = teacher_mapping.get(row['class_name'])
            if teacher_id:
                supabase.table('teacher_student_assignments').insert({
                    "teacher_id": teacher_id,
                    "student_id": user_id,
                    "class_name": row['class_name']
                }).execute()
            
            print(f"✅ {row['full_name']} ({row['email']}) - 성공")
            
        except Exception as e:
            print(f"❌ {row['full_name']} ({row['email']}) - 실패: {e}")
```

---

## 📊 생성 후 확인

### 1. 로그인 테스트

```
이메일: naru1@abs.com
비밀번호: naru1
```

### 2. 데이터베이스 확인

```sql
-- Auth 계정 확인
SELECT 
  au.email,
  up.full_name,
  up.class_name,
  up.student_number
FROM auth.users au
JOIN user_profiles up ON au.id = up.id
WHERE up.class_name = '나루초 3학년 다솜반'
ORDER BY CAST(up.student_number AS INTEGER);
```

### 3. 교사 대시보드 확인

각 선생님 계정으로 로그인하여 학생 목록 확인

---

## 📋 학생 로그인 정보 출력

### 학생에게 전달할 자료 생성

```sql
-- 반별 로그인 정보 출력
SELECT 
  up.class_name AS 반,
  up.student_number AS 번호,
  up.full_name AS 이름,
  au.email AS 이메일,
  CASE 
    WHEN au.email LIKE 'naru%' THEN REPLACE(au.email, '@abs.com', '')
    WHEN au.email LIKE 'uam%' THEN REPLACE(au.email, '@abs.com', '')
    WHEN au.email LIKE '%danjae%' THEN REPLACE(au.email, '@abs.com', '')
  END AS 비밀번호
FROM user_profiles up
JOIN auth.users au ON up.id = au.id
WHERE up.role = 'student'
ORDER BY up.class_name, CAST(up.student_number AS INTEGER);
```

### Excel 다운로드용

CSV로 내보내기:
1. Supabase Dashboard → SQL Editor
2. 위 쿼리 실행
3. Results → Download as CSV

---

## 🔐 보안 권장사항

### 1. 초기 비밀번호 변경 안내

학생들에게 첫 로그인 후 비밀번호 변경 안내:

```
안녕하세요, [이름] 학생!

로그인 정보:
이메일: [이메일]
임시 비밀번호: [비밀번호]

⚠️ 첫 로그인 후 반드시 비밀번호를 변경해주세요!
```

### 2. 비밀번호 정책

Supabase Dashboard → Authentication → Policies에서 설정:
- 최소 길이: 8자
- 복잡도 요구사항 추가

### 3. 이메일 확인 비활성화

테스트 환경에서는 `email_confirm: true` 설정
프로덕션에서는 이메일 확인 활성화 권장

---

## ⚠️ 주의사항

1. **API 제한**: Supabase는 분당 API 호출 제한이 있습니다.
   - 스크립트에 딜레이 추가 (`setTimeout` 100ms)
   - 배치 크기 조절 (20-30명씩)

2. **Service Role Key**: 절대 클라이언트 코드에 노출 금지
   - 서버 사이드에서만 사용
   - .env 파일은 .gitignore에 추가

3. **중복 이메일**: 이미 존재하는 이메일은 오류 발생
   - 기존 계정 먼저 확인
   - 필요시 삭제 후 재생성

---

## 🎯 빠른 실행 체크리스트

- [ ] `학생_이메일_비밀번호_목록.csv` 확인
- [ ] Supabase Service Role Key 준비
- [ ] Node.js 스크립트 실행 또는 수동 등록
- [ ] 로그인 테스트
- [ ] 교사 대시보드에서 학생 목록 확인
- [ ] 학생들에게 로그인 정보 전달

---

## 📞 문제 해결

### 오류: "Email rate limit exceeded"
→ API 호출이 너무 빠릅니다. 딜레이를 늘리세요 (500ms-1000ms)

### 오류: "User already registered"
→ 이미 존재하는 이메일입니다. 다른 이메일을 사용하세요.

### 오류: "Invalid service role key"
→ Service Role Key가 잘못되었습니다. Supabase 설정 확인

---

**모든 학생 계정이 성공적으로 생성되기를 바랍니다! 🎉**

